<!DOCTYPE html>
<html>
<head>
<meta http-equiv='Content-Type' content='text/html; charset=UTF-8' />
<title>demographics survey</title>
<script type='text/javascript' src='https://s3.amazonaws.com/mturk-public/externalHIT_v1.js'></script>
<script src='//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js' type='text/javascript'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.js' type='text/javascript'></script>
<link rel='stylesheet' type='text/css' href='//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.css'>
</head>
<body>
    <div class='container'>
        <div class='row'>
            <div class='col-md-3 col-sm-6 center-block' style='float: none !important'>
                <form name='mturk_form' method='post' id='mturk_form' style='display:none'
                    action='${endpoint}/mturk/externalSubmit'>
                    <input type='hidden' value='' name='assignmentId' id='assignmentId' />
                    <div class='form-group'>
                        <label>1. What is your gender?</label>
                        <div class='radio'>
                          <label>
                            <input type='radio' name='gender' value='male'>
                            Male
                          </label>
                        </div>
                        <div class='radio'>
                          <label>
                            <input type='radio' name='gender' value='female'>
                            Female
                          </label>
                        </div>
                    </div>
                    <div class='form-group'>
                    	<label for='yearOfBirth'>2. What is your year of birth?</label>
                        <select class='form-control' id='yearOfBirth' name='yearOfBirth'>
                            <option value=''></option>
                        </select>
                    </div>
                    <div class='form-group'>
                    	<label for='maritalStatus'>3. Your marital status?</label>
                        <select class='form-control' id='maritalStatus' name='maritalStatus'>
                            <option value=''></option>
                            <option value='cohabitating'>cohabitating</option>
                            <option value='divorced'>divorced</option>
                            <option value='engaged'>engaged</option>
                            <option value='married'>married</option>
                            <option value='separated'>separated</option>
                            <option value='single'>single</option>
                            <option value='widowed'>widowed</option>
                        </select>
                    </div>
                    <div class='form-group'>
                    	<label for='householdSize'>4. Household size?</label>
                        <select class='form-control' id='householdSize' name='householdSize'>
                            <option value=''></option>
                            <option value='1'>1</option>
                            <option value='2'>2</option>
                            <option value='3'>3</option>
                            <option value='4'>4</option>
                            <option value='5+'>5+</option>
                        </select>
                    </div>
                    <div class='form-group'>
                    	<label for='householdIncome'>5. Household income?</label>
                        <select class='form-control' id='householdIncome' name='householdIncome'>
                            <option value=''></option>
                        	<option value='Less than $10,000'>Less than $10,000</option>
                        	<option value='$10,000-$14,999'>$10,000-$14,999</option>
                            <option value='$15,000-$24,999'>$15,000-$24,999</option>
                            <option value='$25,000-$39,999'>$25,000-$39,999</option>
                            <option value='$40,000-$59,999'>$40,000-$59,999</option>
                            <option value='$60,000-$74,999'>$60,000-$74,999</option>
                            <option value='$75,000-$99,999'>$75,000-$99,999</option>
                            <option value='$100,000-$149,999'>$100,000-$149,999</option>
                            <option value='$150,000-$199,999'>$150,000-$199,999</option>
                            <option value='$200,000-$249,999'>$200,000-$249,999</option>
                            <option value='$300,000 or more'>$300,000 or more</option>
                        </select>
                    </div>
                    <br><div class='alert alert-success' role='alert' style='display:none' id='survey-notification'>This HIT can be completed once a month.</div>
                    <br><div class='alert alert-danger' role='alert' style='display:none' id='validation-error'>All fields are required!</div>
                    <input type='submit' id='submitButton' class='btn btn-primary' style='margin-top: 5px;' value='Submit' />
                </form>
                <br>
                <div class='alert alert-danger' role='alert' style='display:none' id='survey-error'>
                    You already have answered this HIT <span id='answer-date'></span>.
                    <br>You can answer again on <span id='allowed-date'></span>.
                </div>
            </div>
        </div>
    </div>
    <script type='text/javascript'>
        $(document).ready(function() {
            var assignmentId = turkGetParam('assignmentId', '');
            var hitId = turkGetParam('hitId', '');
            var workerId = turkGetParam('workerId', '');
            $('#assignmentId').val(assignmentId);

            var years;
            years += '<option value=""></option>';
            for(var i=1910; i<=2010; i++) {
                years += '<option value="' + i + '">' + i + '</option>';
            }
            $('#yearOfBirth').html(years);
            
            if(workerId) {
                $.get('https://mturk-surveys.appspot.com/getAnswer?workerId=' + workerId + '&surveyId=${surveyId}',
                        function(response) {
                            if(response) {
                                $('#answer-date').text(response.date);
                                var allowedDate = new Date(response.date);
                                allowedDate.setMonth(allowedDate.getMonth() + 1);
                                allowedDate.setDate(allowedDate.getDate() + 1);
                                $('#allowed-date').text(moment(allowedDate).format('ll'));
                                $('#survey-error').show();
                            } else {
                                $('#mturk_form').show();
                            }
                }, 'jsonp');
            } else {
                $('#mturk_form').show();
                $('#survey-notification').show();
            }

            if (assignmentId == 'ASSIGNMENT_ID_NOT_AVAILABLE') {
                $('#submitButton').attr('disabled', true);
                $('#submitButton').val('You must ACCEPT the HIT before you can submit the results.');
            }

            var formSubmitted = false;
            $('#mturk_form').submit(function(event) {
                if(formSubmitted == false) {
                    var params = {answers: {}};
                    params.hitId = hitId;
                    params.workerId = workerId;
                    params.surveyId='${surveyId}';
                    params.answers.gender = $('input[name="gender"]:checked', '#mturk_form').val();
                    params.answers.yearOfBirth = $('#yearOfBirth').val();
                    params.answers.maritalStatus = $('#maritalStatus').val();
                    params.answers.householdSize = $('#householdSize').val();
                    params.answers.householdIncome = $('#householdIncome').val();

                    if(!params.answers.gender || params.answers.yearOfBirth == '' ||
                            params.answers.yearOfBirth == '' || params.answers.maritalStatus == '' ||
                            params.answers.householdSize == '' || params.answers.householdIncome == '') {
                        $('#validation-error').show();
                        event.preventDefault();
                        return;
                    }

                    $.ajax({
            			type : 'GET',
            			url : 'https://mturk-surveys.appspot.com/saveAnswerNew?userAnswer='
            			        + encodeURIComponent(JSON.stringify(params)),
            			dataType: 'jsonp'
            		}).done(function(data) {
                        formSubmitted = true;
                        $('#mturk_form').submit();
            		}).fail(function(jqXHR, textStatus, errorThrown) {
            		    console.log('fail');
            		});
                    event.preventDefault();
                }
            });
        })
    </script>
</body>
</html>